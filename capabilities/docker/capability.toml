[capability]
id = "docker"
name = "Docker"
description = "Docker engine for container management"

[packages]
system = ["docker-ce", "docker-ce-cli", "containerd.io", "docker-compose-plugin"]
setup_script = """
#!/bin/bash
set -e
# Add Docker's official GPG key and repository (idempotent)

# Ensure keyring directory exists
sudo mkdir -p /etc/apt/keyrings
sudo chmod 755 /etc/apt/keyrings

# Download and verify GPG key only if not present
if [ ! -f /etc/apt/keyrings/docker.asc ]; then
    echo "Downloading Docker GPG key..."
    sudo curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
    sudo chmod a+r /etc/apt/keyrings/docker.asc

    # Verify GPG key fingerprint for security
    # Official Docker GPG key fingerprint from https://docs.docker.com/engine/install/debian/
    EXPECTED_FINGERPRINT="9DC858229FC7DD38854AE2D88D81803C0EBFCD88"
    ACTUAL_FINGERPRINT=$(gpg --show-keys --with-colons /etc/apt/keyrings/docker.asc 2>/dev/null | awk -F: '/^fpr:/ {print $10; exit}')

    if [ "$ACTUAL_FINGERPRINT" != "$EXPECTED_FINGERPRINT" ]; then
        echo "ERROR: Docker GPG key fingerprint mismatch!"
        echo "Expected: $EXPECTED_FINGERPRINT"
        echo "Got:      $ACTUAL_FINGERPRINT"
        echo "This may indicate a security issue. Aborting."
        sudo rm -f /etc/apt/keyrings/docker.asc
        exit 1
    fi
    echo "âœ“ Docker GPG key fingerprint verified"
else
    echo "Docker GPG key already present"
fi

# Add repository only if not already configured
if ! grep -q "download.docker.com" /etc/apt/sources.list.d/docker.list 2>/dev/null; then
    echo "Adding Docker repository..."
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian $(. /etc/os-release && echo \\"$VERSION_CODENAME\\") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
else
    echo "Docker repository already configured"
fi
"""

[vm_setup]
script = """
#!/bin/bash
set -e
# Add user to docker group for non-root access
sudo usermod -aG docker $(whoami)
echo "Docker installed successfully."
docker --version
"""

[vm_runtime]
script = """
#!/bin/bash
# Write Docker context for Claude
mkdir -p ~/.claude-vm/context
cat > ~/.claude-vm/context/docker.txt <<EOF
Docker version: $(docker --version 2>/dev/null || echo "not available")
Docker Compose version: $(docker compose version 2>/dev/null || echo "not available")
Docker daemon status: $(systemctl is-active docker 2>/dev/null || echo "unknown")
EOF
"""
