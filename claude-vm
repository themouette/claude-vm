#!/usr/bin/env bash
#
# claude-vm: Run Claude Code inside a sandboxed Lima VM
# Based on https://github.com/sylvinus/agent-vm
#
# Usage:
#   claude-vm setup [options] - Create the VM template (run once per project)
#   claude-vm shell            - Open a debug shell in a fresh VM
#   claude-vm [args]           - Run Claude in a fresh VM with cwd mounted (args forwarded to claude)

# Get project identifier based on git root or current directory
# For git worktrees, uses the main repo location so all worktrees share the same template
get-project-id() {
  local project_root
  local git_common_dir

  # Try to get git common dir first (handles worktrees)
  if git_common_dir=$(git rev-parse --git-common-dir 2>/dev/null); then
    # For worktrees, git-common-dir points to the main repo's .git directory (absolute path)
    # For regular repos, it returns .git (relative path)
    # Convert to absolute path and get the parent directory
    project_root=$(cd "$git_common_dir" && cd .. && pwd)
    echo "$project_root"
  else
    # Not in a git repo, use current directory
    pwd
  fi
}

# Get template name for current project
get-template-name() {
  local project_id=$(get-project-id)
  # Get the project basename
  local project_name=$(basename "$project_id")
  # Sanitize: lowercase, replace invalid chars with dash, collapse consecutive dashes, remove leading/trailing dashes
  local sanitized=$(echo "$project_name" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed -E 's/-+/-/g' | sed 's/^-//;s/-$//')
  # Create a short hash of the project path for uniqueness
  local project_hash=$(echo -n "$project_id" | md5 | cut -c1-8)
  echo "claude-tpl_${sanitized}_${project_hash}"
}

claude-vm-setup() {
  local install_docker=false
  local install_node=false
  local install_python=false
  local install_chromium=false
  local disk=20
  local memory=8
  local -a custom_setup_scripts=()

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --help|-h)
        echo "Usage: claude-vm setup [OPTIONS]"
        echo ""
        echo "Create a VM template for the current project with Claude Code pre-installed."
        echo "By default, installs only: git, curl, jq, and Claude Code"
        echo ""
        echo "Optional Tools:"
        echo "  --docker       Install Docker CE with compose plugin"
        echo "  --node         Install Node.js 22"
        echo "  --python       Install Python 3 with pip and venv"
        echo "  --chromium     Install Chromium browser (headless capable)"
        echo "                 Note: Chrome MCP server requires Node.js (--node)"
        echo "  --all          Install all optional tools (docker, node, python, chromium)"
        echo ""
        echo "VM Options:"
        echo "  --disk GB      VM disk size (default: 20)"
        echo "  --memory GB    VM memory (default: 8)"
        echo ""
        echo "Custom Setup:"
        echo "  --setup-script <path>  Run additional setup script (can be used multiple times)"
        echo ""
        echo "Other:"
        echo "  --help         Show this help"
        return 0
        ;;
      --docker)
        install_docker=true
        shift
        ;;
      --node)
        install_node=true
        shift
        ;;
      --python)
        install_python=true
        shift
        ;;
      --chromium)
        install_chromium=true
        shift
        ;;
      --all)
        install_docker=true
        install_node=true
        install_python=true
        install_chromium=true
        shift
        ;;
      --disk)
        disk="$2"
        shift 2
        ;;
      --disk=*)
        disk="${1#*=}"
        shift
        ;;
      --memory)
        memory="$2"
        shift 2
        ;;
      --memory=*)
        memory="${1#*=}"
        shift
        ;;
      --setup-script)
        if [ -z "$2" ]; then
          echo "Error: --setup-script requires a path argument" >&2
          return 1
        fi
        if [ ! -f "$2" ]; then
          echo "Error: Setup script not found: $2" >&2
          return 1
        fi
        custom_setup_scripts+=("$2")
        shift 2
        ;;
      --setup-script=*)
        local script_path="${1#*=}"
        if [ ! -f "$script_path" ]; then
          echo "Error: Setup script not found: $script_path" >&2
          return 1
        fi
        custom_setup_scripts+=("$script_path")
        shift
        ;;
      *)
        echo "Unknown option: $1" >&2
        echo "Run 'claude-vm setup --help' for usage information" >&2
        return 1
        ;;
    esac
  done

  if ! command -v limactl &>/dev/null; then
    if command -v brew &>/dev/null; then
      echo "Installing Lima..."
      brew install lima
    else
      echo "Error: Lima is required. Install from https://lima-vm.io/docs/installation/" >&2
      return 1
    fi
  fi

  local project_id=$(get-project-id)
  local template_name=$(get-template-name)

  echo "Creating VM template for project: $project_id"
  echo "Template name: $template_name"

  limactl stop "$template_name" &>/dev/null
  limactl delete "$template_name" --force &>/dev/null

  echo "Creating VM template..."
  limactl create --name="$template_name" template:debian-13 \
    --set '.mounts=[]' \
    --disk="$disk" \
    --memory="$memory" \
    --tty=false
  limactl start "$template_name"

  # Store project metadata in the VM
  limactl shell "$template_name" bash -c "mkdir -p ~/.claude-vm && echo '$project_id' > ~/.claude-vm/project-root"

  # Disable needrestart's interactive prompts
  limactl shell "$template_name" sudo bash -c 'mkdir -p /etc/needrestart/conf.d && echo "\$nrconf{restart} = '"'"'a'"'"';" > /etc/needrestart/conf.d/no-prompt.conf'

  echo "Installing base packages..."
  limactl shell "$template_name" sudo DEBIAN_FRONTEND=noninteractive apt-get update
  limactl shell "$template_name" sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
    git curl jq wget build-essential ripgrep fd-find htop unzip zip ca-certificates

  # Install optional tools based on flags
  if $install_docker; then
    echo "Installing Docker..."
    limactl shell "$template_name" bash -c '
      sudo install -m 0755 -d /etc/apt/keyrings
      sudo curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
      sudo chmod a+r /etc/apt/keyrings/docker.asc
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
    '
    limactl shell "$template_name" sudo DEBIAN_FRONTEND=noninteractive apt-get update
    limactl shell "$template_name" sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
      docker-ce docker-ce-cli containerd.io docker-compose-plugin

    # Add user to docker group
    limactl shell "$template_name" bash -c 'sudo usermod -aG docker $(whoami)'
  fi

  if $install_python; then
    echo "Installing Python 3..."
    limactl shell "$template_name" sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
      python3 python3-pip python3-venv
  fi

  if $install_node; then
    echo "Installing Node.js 22..."
    limactl shell "$template_name" bash -c "curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -"
    limactl shell "$template_name" sudo DEBIAN_FRONTEND=noninteractive apt-get install -y nodejs
  fi

  if $install_chromium; then
    echo "Installing Chromium..."
    limactl shell "$template_name" sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
      chromium \
      fonts-liberation \
      xvfb
    # Symlink so tools looking for google-chrome find Chromium
    limactl shell "$template_name" sudo ln -sf /usr/bin/chromium /usr/bin/google-chrome
    limactl shell "$template_name" sudo ln -sf /usr/bin/chromium /usr/bin/google-chrome-stable
    limactl shell "$template_name" bash -c 'sudo mkdir -p /opt/google/chrome && sudo ln -sf /usr/bin/chromium /opt/google/chrome/chrome'
  fi

  # Install Claude Code
  echo "Installing Claude Code..."
  limactl shell "$template_name" bash -c "curl -fsSL https://claude.ai/install.sh | bash"
  limactl shell "$template_name" bash -c 'echo "export PATH=\$HOME/.local/bin:\$HOME/.claude/local/bin:\$PATH" >> ~/.bashrc'

  # Authenticate Claude (saves token in template, inherited by clones)
  echo "Setting up Claude authentication..."
  limactl shell "$template_name" bash -lc "claude 'Ok I am logged in, I can exit now.'"

  # Configure Chrome DevTools MCP server if Chromium is installed
  if $install_chromium; then
    echo "Configuring Chrome MCP server..."
    if ! $install_node; then
      echo "  Note: Chrome MCP requires Node.js to run. Use --node flag or install Node.js later."
    fi
    limactl shell "$template_name" bash << 'VMEOF'
CONFIG="$HOME/.claude.json"
if [ -f "$CONFIG" ]; then
  jq '.mcpServers["chrome-devtools"] = {
    "command": "npx",
    "args": ["-y", "chrome-devtools-mcp@latest", "--headless=true", "--isolated=true"]
  }' "$CONFIG" > "$CONFIG.tmp" && mv "$CONFIG.tmp" "$CONFIG"
else
  cat > "$CONFIG" << 'JSON'
{
  "mcpServers": {
    "chrome-devtools": {
      "command": "npx",
      "args": ["-y", "chrome-devtools-mcp@latest", "--headless=true", "--isolated=true"]
    }
  }
}
JSON
fi
VMEOF
  fi

  # Run user's custom setup script if it exists
  local user_setup="$HOME/.claude-vm.setup.sh"
  if [ -f "$user_setup" ]; then
    echo "Running custom setup from $user_setup..."
    limactl shell "$template_name" bash < "$user_setup"
  fi

  # Run project-specific setup script if it exists
  local project_setup="$project_id/.claude-vm.setup.sh"
  if [ -f "$project_setup" ]; then
    echo "Running project setup from $project_setup..."
    limactl shell "$template_name" bash < "$project_setup"
  fi

  # Run custom setup scripts provided via --setup-script flags
  for script in "${custom_setup_scripts[@]}"; do
    echo "Running custom setup script: $script..."
    limactl shell "$template_name" bash < "$script"
  done

  limactl stop "$template_name"

  echo "Template ready for project: $project_id"
  echo "Run 'claude-vm' in this project directory to use it."
}

claude-vm-run() {
  local args=("$@")
  local project_id=$(get-project-id)
  local template_name=$(get-template-name)
  local vm_name="${template_name}-$$"
  local host_dir="$(pwd)"

  if ! limactl list -q 2>/dev/null | grep -q "^${template_name}$"; then
    echo "Error: Template VM not found for project: $project_id" >&2
    echo "Run 'claude-vm setup' first in this project." >&2
    return 1
  fi

  _claude_vm_cleanup() {
    echo "Cleaning up VM..."
    limactl stop "$vm_name" &>/dev/null
    limactl delete "$vm_name" --force &>/dev/null
  }
  trap _claude_vm_cleanup EXIT INT TERM

  echo "Starting VM '$vm_name' from template '$template_name'..."
  limactl clone "$template_name" "$vm_name" \
    --set ".mounts=[{\"location\":\"${host_dir}\",\"writable\":true}]" \
    --tty=false &>/dev/null

  limactl start "$vm_name" &>/dev/null

  # Run project-specific runtime script if it exists
  if [ -f "${host_dir}/.claude-vm.runtime.sh" ]; then
    echo "Running project runtime setup..."
    limactl shell --workdir "$host_dir" "$vm_name" bash -l < "${host_dir}/.claude-vm.runtime.sh"
  fi

  limactl shell --workdir "$host_dir" "$vm_name" claude --dangerously-skip-permissions "${args[@]}"

  _claude_vm_cleanup
  trap - EXIT INT TERM
}

claude-vm-shell() {
  local project_id=$(get-project-id)
  local template_name=$(get-template-name)
  local vm_name="${template_name}-debug-$$"
  local host_dir="$(pwd)"

  if ! limactl list -q 2>/dev/null | grep -q "^${template_name}$"; then
    echo "Error: Template VM not found for project: $project_id" >&2
    echo "Run 'claude-vm setup' first in this project." >&2
    return 1
  fi

  _claude_vm_shell_cleanup() {
    echo "Cleaning up VM..."
    limactl stop "$vm_name" &>/dev/null
    limactl delete "$vm_name" --force &>/dev/null
  }
  trap _claude_vm_shell_cleanup EXIT INT TERM

  limactl clone "$template_name" "$vm_name" \
    --set ".mounts=[{\"location\":\"${host_dir}\",\"writable\":true}]" \
    --tty=false &>/dev/null

  limactl start "$vm_name" &>/dev/null

  # Run project-specific runtime script if it exists
  if [ -f "${host_dir}/.claude-vm.runtime.sh" ]; then
    limactl shell --workdir "$host_dir" "$vm_name" bash -l < "${host_dir}/.claude-vm.runtime.sh"
  fi

  echo "VM: $vm_name | Dir: $host_dir | Project: $project_id"
  echo "Type 'exit' to stop and delete the VM"
  limactl shell --workdir "$host_dir" "$vm_name" bash -l

  _claude_vm_shell_cleanup
  trap - EXIT INT TERM
}

claude-vm-list() {
  echo "Project VM templates:"
  echo ""
  limactl list 2>/dev/null | grep "^claude-tpl_" | while read -r line; do
    local vm_name=$(echo "$line" | awk '{print $1}')
    local status=$(echo "$line" | awk '{print $2}')
    # Try to read project root from VM
    local project_root=""
    if [ "$status" = "Running" ] || [ "$status" = "Stopped" ]; then
      project_root=$(limactl shell "$vm_name" cat ~/.claude-vm/project-root 2>/dev/null || echo "(unknown)")
    fi
    printf "  %-20s %-10s %s\n" "$vm_name" "$status" "$project_root"
  done
}

claude-vm-clean() {
  local project_id=$(get-project-id)
  local template_name=$(get-template-name)

  if ! limactl list -q 2>/dev/null | grep -q "^${template_name}$"; then
    echo "No template found for project: $project_id"
    return 0
  fi

  echo "Deleting template '$template_name' for project: $project_id"
  limactl stop "$template_name" &>/dev/null
  limactl delete "$template_name" --force
  echo "Template deleted."
}

claude-vm-clean-all() {
  echo "Deleting all claude-vm templates..."
  limactl list -q 2>/dev/null | grep "^claude-tpl_" | while read -r vm_name; do
    echo "  Deleting: $vm_name"
    limactl stop "$vm_name" &>/dev/null
    limactl delete "$vm_name" --force &>/dev/null
  done
  echo "All templates deleted."
}

# Main command dispatcher
main() {
  case "${1:-}" in
    setup)
      shift
      claude-vm-setup "$@"
      ;;
    shell)
      shift
      claude-vm-shell "$@"
      ;;
    list)
      claude-vm-list
      ;;
    clean)
      claude-vm-clean
      ;;
    clean-all)
      claude-vm-clean-all
      ;;
    --help|-h|help)
      cat << 'EOF'
Usage: claude-vm [COMMAND] [OPTIONS]

Commands:
  setup [options]  Create VM template for current project (run once per project)
  shell            Open a debug shell in a fresh VM
  list             List all project VM templates
  clean            Delete the template for the current project
  clean-all        Delete all claude-vm templates
  [args...]        Run Claude in a fresh VM (default)

Setup Options:
  By default, installs: git, curl, jq, and Claude Code

  Optional Tools:
    --docker       Install Docker CE with compose plugin
    --node         Install Node.js 22
    --python       Install Python 3 with pip and venv
    --chromium     Install Chromium browser (headless capable)
                   Note: Chrome MCP server requires Node.js (--node)
    --all          Install all optional tools

  VM Options:
    --disk GB      VM disk size (default: 20)
    --memory GB    VM memory (default: 8)

  Custom Setup:
    --setup-script <path>  Run additional setup script (can be used multiple times)

Project Detection:
  Templates are created per-project based on:
  1. Git repository root (git rev-parse --show-toplevel)
  2. Current directory (if not in a git repo)

Examples:
  claude-vm setup                              Create minimal VM template
  claude-vm setup --all                        Create VM template with all tools
  claude-vm setup --docker --node              Create VM template with Docker and Node.js
  claude-vm setup --setup-script ./install.sh  Run custom setup script
  claude-vm "help me with X"                   Run Claude in a sandboxed VM
  claude-vm shell                              Open debug shell in a fresh VM
  claude-vm list                               List all project templates
  claude-vm clean                              Delete current project's template

Based on: https://github.com/sylvinus/agent-vm
EOF
      ;;
    *)
      claude-vm-run "$@"
      ;;
  esac
}

# Run main function with all arguments
main "$@"
