#!/usr/bin/env bash
set -e

# Development environment setup script for claude-vm-rust
# Supports: macOS and Linux (Debian/Ubuntu)

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() {
  echo -e "${BLUE}==>${NC} $1"
}

log_success() {
  echo -e "${GREEN}✓${NC} $1"
}

log_warning() {
  echo -e "${YELLOW}⚠${NC} $1"
}

log_error() {
  echo -e "${RED}✗${NC} $1"
}

# Detect OS
detect_os() {
  if [[ "$OSTYPE" == "darwin"* ]]; then
    OS="macos"
    log_info "Detected macOS"
  elif [[ -f /etc/debian_version ]]; then
    OS="debian"
    log_info "Detected Debian/Ubuntu Linux"
  else
    log_error "Unsupported operating system: $OSTYPE"
    exit 1
  fi
}

# Check if a command exists
command_exists() {
  command -v "$1" >/dev/null 2>&1
}

# Install Homebrew (macOS only)
install_homebrew() {
  if [[ "$OS" == "macos" ]]; then
    if ! command_exists brew; then
      log_info "Installing Homebrew..."
      /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      log_success "Homebrew installed"
    else
      log_success "Homebrew already installed"
    fi
  fi
}

# Install Rust
install_rust() {
  if ! command_exists rustc; then
    log_info "Installing Rust..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source "$HOME/.cargo/env"
    log_success "Rust installed"
  else
    local rust_version=$(rustc --version | awk '{print $2}')
    log_success "Rust already installed (version $rust_version)"

    # Update Rust to latest stable
    log_info "Updating Rust to latest stable..."
    rustup update stable
    log_success "Rust updated"
  fi
}

# Install Lima (macOS and Linux)
install_lima() {
  if ! command_exists limactl; then
    log_info "Installing Lima..."

    if [[ "$OS" == "macos" ]]; then
      brew install lima
      log_success "Lima installed via Homebrew"
    else
      # Linux installation
      log_info "Installing Lima on Linux..."
      local lima_version="v0.23.2"
      local arch=$(uname -m)

      case "$arch" in
        x86_64)
          lima_arch="x86_64"
          ;;
        aarch64|arm64)
          lima_arch="aarch64"
          ;;
        *)
          log_error "Unsupported architecture: $arch"
          exit 1
          ;;
      esac

      local lima_url="https://github.com/lima-vm/lima/releases/download/${lima_version}/lima-${lima_version#v}-Linux-${lima_arch}.tar.gz"

      log_info "Downloading Lima from $lima_url"
      curl -fsSL "$lima_url" | sudo tar Cxzf /usr/local -

      log_success "Lima installed"
    fi
  else
    local lima_version=$(limactl --version | head -n1 | awk '{print $3}')
    log_success "Lima already installed (version $lima_version)"
  fi
}

# Install development dependencies
install_dev_deps() {
  log_info "Installing development dependencies..."

  if [[ "$OS" == "macos" ]]; then
    # macOS dependencies
    local deps=(git jq)
    for dep in "${deps[@]}"; do
      if ! command_exists "$dep"; then
        log_info "Installing $dep..."
        brew install "$dep"
      else
        log_success "$dep already installed"
      fi
    done
  else
    # Linux dependencies
    log_info "Updating apt package list..."
    sudo apt-get update

    local deps=(git curl jq build-essential)
    log_info "Installing: ${deps[*]}"
    sudo DEBIAN_FRONTEND=noninteractive apt-get install -y "${deps[@]}"
    log_success "Development dependencies installed"
  fi
}

# Install Rust development tools
install_rust_tools() {
  log_info "Installing Rust development tools..."

  # Ensure cargo is in PATH
  if command_exists cargo; then
    # Install clippy (linter)
    if ! rustup component list | grep -q "clippy.*installed"; then
      log_info "Installing clippy..."
      rustup component add clippy
      log_success "Clippy installed"
    else
      log_success "Clippy already installed"
    fi

    # Install rustfmt (formatter)
    if ! rustup component list | grep -q "rustfmt.*installed"; then
      log_info "Installing rustfmt..."
      rustup component add rustfmt
      log_success "Rustfmt installed"
    else
      log_success "Rustfmt already installed"
    fi

    # Install cargo-watch (auto-rebuild on file changes) - optional
    if ! command_exists cargo-watch; then
      log_info "Installing cargo-watch (optional)..."
      cargo install cargo-watch --quiet || log_warning "Failed to install cargo-watch (optional)"
    else
      log_success "Cargo-watch already installed"
    fi
  else
    log_error "Cargo not found in PATH. Please restart your shell and run this script again."
    exit 1
  fi
}

# Verify installation
verify_installation() {
  log_info "Verifying installation..."

  local all_good=true

  # Check Rust
  if command_exists rustc && command_exists cargo; then
    log_success "Rust: $(rustc --version)"
  else
    log_error "Rust not found"
    all_good=false
  fi

  # Check Lima (only on macOS)
  if [[ "$OS" == "macos" ]]; then
    if command_exists limactl; then
      log_success "Lima: $(limactl --version | head -n1)"
    else
      log_warning "Lima not found (required for running claude-vm)"
      all_good=false
    fi
  else
    log_warning "Lima installation not verified on Linux (may require manual setup)"
  fi

  # Check Git
  if command_exists git; then
    log_success "Git: $(git --version)"
  else
    log_error "Git not found"
    all_good=false
  fi

  if $all_good; then
    log_success "All required tools installed!"
  else
    log_error "Some tools are missing. Please review the errors above."
    exit 1
  fi
}

# Build the project
build_project() {
  log_info "Building claude-vm..."
  cd "$PROJECT_ROOT"

  # Ensure cargo is in PATH
  if ! command_exists cargo; then
    export PATH="$HOME/.cargo/bin:$PATH"
  fi

  cargo build
  log_success "Project built successfully"
}

# Run tests
run_tests() {
  log_info "Running tests..."
  cd "$PROJECT_ROOT"

  cargo test --all
  log_success "All tests passed"
}

# Main setup flow
main() {
  echo ""
  log_info "Setting up claude-vm development environment"
  echo ""

  detect_os
  install_homebrew
  install_dev_deps
  install_rust
  install_lima
  install_rust_tools
  verify_installation

  echo ""
  log_info "Building project..."
  build_project

  echo ""
  log_info "Running tests..."
  run_tests

  echo ""
  log_success "Development environment setup complete!"
  echo ""
  echo "Next steps:"
  echo "  1. Build release binary:  cargo build --release"
  echo "  2. Run tests:             cargo test"
  echo "  3. Run linter:            cargo clippy"
  echo "  4. Format code:           cargo fmt"
  echo "  5. Install locally:       cargo install --path ."
  echo ""

  if [[ "$OS" == "macos" ]]; then
    echo "To use lima, you may need to start the default VM:"
    echo "  limactl start"
    echo ""
  fi
}

# Run main function
main
